jpsType: install
jpsVersion: '1.4'
id: MailServer
name: Mail Server
homepage: https://www.postfix.org/
version: 0.0.1
appVersion: 7.9
baseUrl: https://raw.githubusercontent.com/cyfran/mail/main/

categories:
  - apps/collaboration

description:
    text: description.md
    short: Postfix is an open-source email server.
logo: bigbluebutton.png

requiredFeatures: extip
ssl: false
skipNodeEmails: true

globals:
  emailssecret: ${fn.password}

nodes:
  nodeType: docker
  image: centos:centos7
  nodeGroup: cp
  cloudlets: 16
  extip: true
  displayName: Email Server
  
settings:    
  domain: 
          fields: 
          - name: displayfield
            type: displayfield
            hideLabel: true
            markup: Make sure the the new domain is bound already to the environment via CNAME or via A Record 
          - name: domain
            hideLabel: true
            caption: Domain
            type: string
  fields:
          - type: string
            name: domaintld
            caption: Domain Name
            value: domain.tld
          - type: string
            name: email
            caption: Email
            value: address@
        
onInstall:
    - install-mail
    
actions:
    install-mail:
        - cmd[cp]: |-
            groupadd vmail -g5000
            useradd vmail -u 5000 -g 5000 -m -s /sbin/nologin
            yum install postfix dovecot -y
            wget -O /etc/postfix/main.cf https://raw.githubusercontent.com/cyfran/mail/main/postfix/main.cf
            wget -O /etc/dovecot/dovecot.conf https://raw.githubusercontent.com/cyfran/mail/main/dovecot/dovecot.conf
            wget -O /etc/postfix/vhosts https://raw.githubusercontent.com/cyfran/mail/main/postfix/vhosts
            sed -i "s|DOMAIN.TLD|${settings.domaintld}|g" /etc/postfix/vhosts
            sed -i "s|myhostname = mail.DOMAIN.TLD|myhostname = mail.${settings.domaintld}|g" /etc/postfix/main.cf
            postmap /etc/postfix/vhosts
            doveadm pw -p ${globals.emailssecret} -s sha1 | cut -d '}' -f2 > /etc/dovecot/passwd
            echo ${globals.emailssecret} > /etc/dovecot/pass
            service postfix restart
            service dovecot restart
 
startPage: https://${env.domain}
success:
    text:
    en: |
        Below you will find your admin panel link, username and password.
        **Admin panel URL:** [https://${env.domain}/](https://${env.domain}/)   
        **Public IPv4:** ${nodes.cp.extIPs}
        **Public IPv6:** ${nodes.cp.extipsv6} 
        **API Secret:** ```${globals.emailssecret}```

    ru: |
        Ниже вы найдете ссылку на панель администратора, имя пользователя и пароль.
        **Admin panel URL:** [https://${env.domain}/](https://${env.domain}/)
        **Public IPv4:** ${nodes.cp.extIPs}
        **Public IPv6:** ${nodes.cp.extipsv6}     
        **API Secret:** ```${globals.emailssecret}```
